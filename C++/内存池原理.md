# 内存池原理

#### 内碎片和外碎片

内碎片：分配内存和其中有效载荷之差，未利用

外碎片：空闲的内存片无法形成一块大的连续空间

--------

#### 为什么要使用内存池？

* 由于一次性申请的内存较大，可以降低外碎片问题

* 一次性申请内存，防止频繁的系统调用，提高内存分配的效率

* 尽可能的降低内碎片的问题

  ---------------------

#### 哈希映射的FreeList 池

在定长分配器的基础上，按照不同对象大小(8，16，32，64，128，256，512，1k…64K),构造十多个固定内存分配器，分配内存时根据要申请内存大小进行对齐然后查H表，决定到底由哪个分配器负责，分配后要在内存头部的 header 处写上 cookie，表示由该块内存哪一个分配器分配的，这样释放时候你才能正确归还。如果大于64K，则直接用系统的 malloc作为分配，如此以浪费内存为代价你得到了一个分配时间近似O(1)的内存分配器。这种内存池的缺点是假设某个 FreeList 如果高峰期占用了大量内存即使后面不用，也无法支援到其他内存不够的 FreeList，达不到分配均衡的效果。

**优点：**这个本质是定长内存池的改进，分配和释放的效率高。可以解决一定长度内的问题。

**缺点：**存在内碎片的问题，且将一块大内存切小以后，申请大内存无法使用。多线程并发场景下，锁竞争激烈，效率降低。

**范例：**sgi stl 六大组件中的空间配置器就是这种设计实现的。