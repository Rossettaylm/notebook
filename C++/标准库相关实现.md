# 标准库相关实现

## string

#### copy-on-write机制的实现

通过引用计数，来使用共享内存的方式，防止多余的拷贝，同时只有在`ref_cnt = 0`时，才真正从堆中释放内存。

使用共享内存的情况包括：

* 以别的类构造自己 -- 拷贝构造
* 以别的类赋值 -- 拷贝赋值

其他情况，如

```cpp
char tmp[] = "helloworld";
string str1 = tmp;
string str2 = tmp;

// 并不发生共享内存，因为都是直接由const char* 直接构造而来
```

当必须进行修改时，如`append`, `replace`, `+=`操作符等有写操作时，才进行copy-on-write。

##### 实现机制

将`ref_cnt`分配到共享内存的前几个字节。

* 只要发生拷贝构造或者赋值时，将计数加1。
* 发生写操作时，将自身数据复制一份，再进行修改。
* 发生析构时，先判断是否`ref_cnt`为0，是再释放内存，否则将引用计数减一。